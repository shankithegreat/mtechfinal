<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Analysis</title>
    <script src="tailwind.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="outfit.css">
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center p-4">
    <div class="glass-panel p-8 rounded-2xl w-full max-w-4xl relative z-10">
        <h1 class="text-3xl font-bold text-white mb-6 text-center tracking-tight">Feature Flag ML Analysis</h1>

        <div class="space-y-6">
            <!-- Model Selection -->
            <div class="space-y-2">
                <label class="text-gray-400 text-sm font-medium ml-1">Select ML Model</label>
                <div class="relative">
                    <select id="model_type"
                        class="w-full bg-slate-800/50 border border-slate-700 text-white text-sm rounded-xl focus:ring-blue-500 focus:border-blue-500 block p-4 shadow-sm appearance-none cursor-pointer transition-all hover:bg-slate-800/70">
                        <option value="anomaly">Anomaly Detection</option>
                        <option value="staleness">Staleness Prediction</option>
                        <option value="risk">Risk Scoring</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-400">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                            <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Analyze Button -->
            <button onclick="analyze()"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                Analyze
            </button>

            <!-- Results -->
            <div id="results" class="space-y-4"></div>
        </div>
    </div>

    <script>
        async function analyze() {
            const model = document.getElementById('model_type').value;
            const button = document.querySelector('button');
            button.disabled = true;
            button.textContent = 'Analyzing...';

            try {
                const response = await fetch('/ml/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model_type: model })
                });
                const data = await response.json();

                let html = '<div class="bg-slate-800/30 rounded-xl p-6 space-y-4">';

                if (model === 'anomaly') {
                    html += '<h2 class="text-xl font-semibold text-white mb-4">Anomaly Detection Results</h2>';
                    html += `<div class="grid grid-cols-2 gap-4"><div class="bg-slate-700/50 p-4 rounded-lg"><p class="text-gray-300">Total Flags</p><p class="text-2xl font-bold text-white">${data.total_flags}</p></div>`;
                    html += `<div class="bg-slate-700/50 p-4 rounded-lg"><p class="text-gray-300">Anomalies Detected</p><p class="text-2xl font-bold text-white">${data.anomalies_detected}</p></div></div>`;
                    html += '<h3 class="text-lg font-medium text-white mt-6 mb-2">Sample Anomalies</h3>';
                    html += '<div class="overflow-x-auto"><table class="w-full bg-slate-700/50 rounded-lg overflow-hidden"><thead class="bg-slate-600"><tr>';
                    html += '<th class="px-4 py-2 text-left text-gray-300">Flag Name</th><th class="px-4 py-2 text-left text-gray-300">Latency</th><th class="px-4 py-2 text-left text-gray-300">Error</th><th class="px-4 py-2 text-left text-gray-300">Conversion Rate</th><th class="px-4 py-2 text-left text-gray-300">Is Anomaly</th></tr></thead><tbody>';
                    data.sample_anomalies.forEach(a => {
                        html += `<tr class="border-t border-slate-600"><td class="px-4 py-2 text-gray-300">${a.flag_name}</td><td class="px-4 py-2 text-gray-300">${a.latency}</td><td class="px-4 py-2 text-gray-300">${a.error}</td><td class="px-4 py-2 text-gray-300">${a.conversion_rate}</td><td class="px-4 py-2 text-gray-300">${a.is_anomaly}</td></tr>`;
                    });
                    html += '</tbody></table></div>';
                    html += `<div class="mt-6"><img src="${data.image_path}" alt="Anomaly Plot" class="w-full rounded-lg shadow-lg"></div>`;
                } else if (model === 'staleness') {
                    html += '<h2 class="text-xl font-semibold text-white mb-4">Staleness Prediction Results</h2>';
                    html += `<div class="grid grid-cols-2 gap-4"><div class="bg-slate-700/50 p-4 rounded-lg"><p class="text-gray-300">MSE</p><p class="text-2xl font-bold text-white">${data.mse.toFixed(4)}</p></div>`;
                    html += `<div class="bg-slate-700/50 p-4 rounded-lg"><p class="text-gray-300">RÂ² Score</p><p class="text-2xl font-bold text-white">${data.r2.toFixed(4)}</p></div></div>`;
                    html += '<h3 class="text-lg font-medium text-white mt-6 mb-2">Feature Importance</h3><ul class="space-y-2">';
                    Object.entries(data.feature_importance).forEach(([f, s]) => {
                        html += `<li class="flex justify-between bg-slate-700/50 p-2 rounded"><span class="text-gray-300">${f}</span><span class="text-white font-medium">${s.toFixed(4)}</span></li>`;
                    });
                    html += '</ul>';
                    html += `<div class="mt-6"><img src="${data.image_path}" alt="Staleness Plot" class="w-full rounded-lg shadow-lg"></div>`;
                } else if (model === 'risk') {
                    html += '<h2 class="text-xl font-semibold text-white mb-4">Risk Scoring Results</h2>';
                    html += `<div class="bg-slate-700/50 p-4 rounded-lg mb-4"><p class="text-gray-300">Accuracy</p><p class="text-2xl font-bold text-white">${data.accuracy.toFixed(4)}</p></div>`;
                    html += '<h3 class="text-lg font-medium text-white mb-2">Classification Report</h3>';
                    html += '<div class="bg-slate-700/50 p-4 rounded-lg overflow-x-auto"><pre class="text-gray-300 text-sm">' + JSON.stringify(data.classification_report, null, 2) + '</pre></div>';
                    html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">';
                    html += `<img src="${data.image_paths[0]}" alt="Confusion Matrix" class="w-full rounded-lg shadow-lg">`;
                    html += `<img src="${data.image_paths[1]}" alt="Feature Importance" class="w-full rounded-lg shadow-lg">`;
                    html += '</div>';
                }

                html += '</div>';
                document.getElementById('results').innerHTML = html;
            } catch (error) {
                document.getElementById('results').innerHTML = '<div class="bg-red-900/50 p-4 rounded-lg text-red-300">Error occurred during analysis. Please try again.</div>';
            } finally {
                button.disabled = false;
                button.textContent = 'Analyze';
            }
        }
    </script>
</body>

</html>